
# Solar Shadow Range Analysis and Raditation test gbXML file and results data file instructions

## [speed result viewer 1]( http://www.ladybug.tools/spider/solar-well/speed-solar-data/speed-result-viewer-1.html )

Previously we evaluated using mesh points, vectors, and analysis values output from ladybug shadow range and solar radiation code to feed back into a three.js scene for visualization. After further thought, this workflow has changed for several reasons. First, it was discovered that Mostapha's code meshes all internal walls, floors, and ground plane areas underneath shading buildings and the main building. This resulted in an unecessarily large number of mesh points and computational overhead. Additionally, while each mesh is generated with a given value of grid size (1m2 in our case), as all the surfaces are different sizes (length and width) it resulted in points very close to the surface edges, meaning that when it was passed back to Theo to visualize the points and their associated analysis values (without the actual geometry as well) it resulted in many serrated edges. Keeping this format would require Theo to determine if a grid point mesh area (the 1m2 centered at the mesh point) went outside the boundary of the polyloop of the surface, and split it so no colored meshes showed up beyond the surface boundary. Furthermore, it was determined that if the meshes were generated by Theo using the gbXML surfaces first, then passed to Mostapha's shadow range and solar radiation code, then we'd have more control over the visualization of the results. Therefore we created the following workflow....

While our geometry starts as raw three.js geometry in the SPEED GUI, we will first generate a gbXML file using our existing code on node.js. This is because we have a need in some parts of the code to know the polyloops for shading surfaces for calculation of shadow masking. Using this gbXML file (which will be generated in either IP or SI), Theo will mesh the follow surfaces in the given unit system:

1. Shadow Range Analysis: (1) The ground plane except the parts beneath the main building and shading buildings and (2) all exterior wall and roof surfaces for the main building. No meshes will be made for other shading surfaces such as overhangs, fins, and adjacent buildings. The ground plane which will be defined as a shading surface in the gbXML file. This surface can be seen in        SPEEDTest.xml as "surfaceType="Shade", id="shade-9", Name=Ground". We will be adding the logic on how to size this ground plane. This ground plane will have to be reconciled with the existing ground plane that is able to be toggled on and off in the gbXML Viewer.

2. Solar Radiation Analysis: (1) The ground plane except the parts beneath the main building and shading buildings and (2) all exterior wall and roof surfaces for the main building and any adjacent building. 

The mesh density for each surface may be different so that the mesh points generated are an evenly distributed set of points when overlayed on the base geometry. The mesh size should be as close to 1m2 (or equivalent IP) as possible. It can be slightly larger or slightly smaller in order to generate the evenly distributed grid based on the specific length and width of the surface. This way when the mesh points and vectors and their associated analysis values are read back into three.js and visualized, they will essentially re-create the gbXML surface exactly.
           
The mesh points and vectors that are generated will be exported to a file called SPEEDmeshes.shadowinput and SPEEDMeshes.radiationinput. Note the number of mesh points will be different in each case since the shading surfaces are meshed for radiation and not shadow range. Along with the x,y,z coordinates of each point and the 3 vector coordinates, the unit system (IP,SI), surface id (shade-XX, surface-XX), and grid size (1.0,1.1,0.987,etc.) of the parent surface will also be exported to these files for debugging purposes . The example files for the file format are SPEEDMeshesExample.shadowinput and SPEEDMeshesExample.radiationinput. The first string is the unit system, the second is surface id, the third, fourth, and fifth are the x,y,z coordinates, respectively, the sixth, seventh, and eighth values are the x,y,z vector coordinates, and the ninth value is the grid size associated with the mesh point (one side of the mesh, so if 0.987m, then area is 0.987^2=0.974169m2..

Using this file, we will run a modified version of Mostapha's ladybug code that is independent of Rhino/GH. For now it will remain a series of python scripts with the appropriate node.js dependencies defined. For .radiationinput and .shadowinput files in IP, we will do an internal conversion to SI for analysis, then convert the results back to IP. The output for the shadow range and solar radiation analysis will be the same format as the input files, but with a tenth value appended to each line item, corresponding to either the hours of sunlight for the shadow range analysis or the cumulative solar radiation values. The files will be called SPEEDmeshes.shadowoutput and SPEEDMeshes.radiationoutput. The example files for the file format are SPEEDMeshesExample.shadowoutput and SPEEDMeshesExample.radiationoutput. 

These files will be read in, parsed, and visualized in three.js (maybe the gbXML viewer?). Only the grid mesh areas and analysis value will be displayed (i.e. no points or vectors), though a toggle may added to the viewer to display them if desired. It is not required.

The resulting scenes should look like the uploaded images for various time periods, which can be annual, fall, winter, spring, summer, a given month, or a given day. Note: Shadow range for a given day will not be handled using the above method. We will use Theo's implemention using three.js light sources.

**Legend and Color-Coding Scheme**

With each analysis visualization, a corresponding legend must be generated. A visual example of what the legend should look like for solar radiation can be found in SolarRadiation_Summer_AllDays_Plan.jpg and for shadow range in ShadowRange_Annual_15_Plan.jpg. Ladybug uses 11 different colors for both the shadow range and solar radiation legends. We'd like to use the same number of color bins and the same colors as they are fairly conventional in other tools. When reading in the .shadowoutput and .radiationoutput files, the max value should be determined for analysis value, and the bins descretized accordingly ((max value-0)/12). Hour values for shadow range will always be whole integers, not rounding needed. Radiation values should be rounding to the nearest tenth decimal (not hundredth as shown in the images). 

Edges of the original gbXML surface geometry should be shown except for windows. We may consider overlaying an analysis grid (different than geometry grid or mesh grid) for the solar radiation results as many find it more visually pleasing. An example of this can be found in the image SolarRadiationGrid_1.jpg. Logic for the grid size is TBD.

For the shadow range analysis, as the shading surfaces for overhangs, fins, and adjacent buildings will not be represented with mesh points, these surfaces are to be included in the scene colored black with a transparency of 0.75.

**Here is my second attempt to clarify the spec...**

These are the steps:

1. You import gbXML file. Have button to import file in interface.

2. You generate mesh points and vectors for each surface in the gbXML file. Requirements for mesh:
           a. As close to 1 m2 as possible if in SI, or 10 ft2 if in IP. This value has been optimized after testing between visualization quality and computational time.
           b. What unit system you are working in based on the units in the imported gbXML file.
           c. A grid mesh should be generated for each exterior surface in the model. Window surfaces are excluded always, as those meshes will be already represented by the meshes in the host exterior wall.
                      i. For Shadow: Exclude almost all shading objects (overhangs, fins, adjacent buildings). But do mesh the shading surface for the ground. We will have it included in the gbXML file. For the ground mesh you may exclude mesh points that are located under the main building or shading building (or just include them and they will be assigned analysis value of 0).
                      ii. For Radiation: Include all surfaces.
                      iii. The mesh should be even distributed such that when you view the mesh surfaces they all combine to form the same shape as the parent surface. In order to allow for this to happen, that’s why the 1 m2 or 10 ft2 mesh size is not fixed. It can float to match the needs of each surface.
           
3.Once the mesh points and vectors are generated,  you export a .shadowinput and .radiationinput file. Have a button to export each file. Here is what is included and the formatting of these files:
           a. Each mesh will have its own line item in the file. Each line item will have 9 values/strings. The general structure of each line item is (UnitSystem,SurfaceID,xCoordinateMeshCenterPoint, yCoordinateMeshCenterPoint, zCoordinateMeshCenterPoint, xVectorMeshCenterPoint, yVectorMeshCenterPoint, zVectorMeshCenterPoint,MeshLength). The mesh length is one side of the mesh (so a length not area). So if mesh is 0.9m x 0.9m, then this value will be 0.9, not 0.9^2=0.81 m2.
           b. Example for a regular gbXML surface: SI,surface-9, -4.705043,-15.25,2.0955,0.0,-1.0,0.0,0.9
           c.Example for a shade gbXML surface: SI,shade-19,-67.189346,-68.695648,0.0,0.0,0.0,1.0,0.95
           d. Note: The SurfaceID is exactly as it shows up in the gbXML file.
           e. Note: The .shadowinput file will have fewer meshes than the .radiationinput file since the shadow range analysis will not include overhangs, fins, or adjacent buildings. Fewer meshes=fewer lines in the file.

At this point, we take the file, run the code for shadow range and solar radiation analysis, then we write out two output files that include the resulting analysis value, a .shadowoutput and .radiationoutput file.

4. Then you will import the .shadowoutput and .radiationoutput files. Have a button to import each. 

5. The structure of the .shadowoutput and .radiationoutput files are exactly the same as the corresponding input files you generate, except there will be a tenth value appended onto it, the analysis value.
           a. The general structure of each line item is (UnitSystem,SurfaceID,xCoordinateMeshCenterPoint, yCoordinateMeshCenterPoint, zCoordinateMeshCenterPoint, xVectorMeshCenterPoint, yVectorMeshCenterPoint, zVectorMeshCenterPoint,MeshLength,AnalysisValue). The AnalysisValue will be either Hours of Sunlight for .shadowoutput or Cumulative Solar Radiation (kWh/m2 for SI, kWh/ft2 for IP) for .radiationoutput.
           b. Example for a regular gbXML surface for .shadowoutput in SI: SI,surface-9, -4.705043,-15.25,2.0955,0.0,-1.0,0.0,0.9,480
           c. Example for a shade gbXML surface for .shadowoutput in SI:  SI,shade-19,-67.189346,-68.695648,0.0,0.0,0.0,1.0,0.95,865
           d. Example for a regular gbXML surface for .radiationoutput in SI: SI,surface-9, -4.705043,-15.25,2.0955,0.0,-1.0,0.0,0.9,1280
           e. Example for a shade gbXML surface for .radiationoutput in SI:  SI,shade-19,-67.189346,-68.695648,0.0,0.0,0.0,1.0,0.95,1500
           
6. Once both files are imported, the user will have the ability to view one or the other. Put a checkbox for “View Shadow Range Results” and “View Solar Radiation Results” below the import buttons.
           a. When viewing the results, the points and vectors do not need to be shown. Only the meshes (MeshLength^2). The cumulative meshes should look like the original gbXML geometry since the mesh size was originally determined based on the gbXML surface size and evenly distributed.
           b. For the view of the .shadowoutput file, you also will need to view the excluded shading surfaces such as overhangs, fins, and adjacent buildings. Use original polyloop geometry from gbXML file. Color the surfaces black with a transparency of 0.75.
           c. The individual mesh colors will be based on the AnalysisValue and a legend of the colors and their associated AnalysisValue ranges generated. A visual example of what the legend should look like for solar radiation can be found in SolarRadiation_Summer_AllDays_Plan.jpg and for shadow range in ShadowRange_Annual_15_Plan.jpg. Ladybug uses 11 different colors for both the shadow range and solar radiation legends. We'd like to use the same number of color bins and the same colors as they are fairly conventional in other tools. When reading in the .shadowoutput and .radiationoutput files, the max value should be determined for analysis value, and the bins discretized accordingly ((max value-0)/12). Hour values for shadow range will always be whole integers, not rounding needed. Radiation values should be rounding to the nearest tenth decimal (not hundredth as shown in the images).
           d. All the polyloops of the original gbXML geometry should be shown in black overlaid on top of the meshes (including windows) . So essentially we are viewing the gbXML file (minus surface fill colors) and the analysis meshes at the same time.

